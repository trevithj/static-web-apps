<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>The Race 01 example</title>
    <style type="text/css" media="screen">
    </style>
</head>

<body>
    <div class="theViz">
    </div>
    <div class="controls">
        <button>Buy RM A</button>
        <button>Buy RM B</button>
        <button>Swap Jobs</button>
    </div>
</body>
<script>
    const viz = document.querySelector("div.theViz");
    const DATA = { job: "a" };

    fetch("./theRace01.svg").then(r => r.text()).then(raw => {
        viz.innerHTML = raw;
        setTimeout(() => {
            // addItemListeners(viz);
            addJobListener(viz);
        }, 0)
    });

    function getRM(suffix) {
        const grp = viz.querySelector(`g#rm-${suffix}`);
        const txt = grp.querySelector("text");
        const qty = parseInt(txt.textContent);
        return { txt, qty };
    }

    function getItem500(suffix) {
        const items = viz.querySelectorAll("g#items500 use");
        console.log(items);
        return suffix==="a" ? items[0] : items[1];
    }

    function buyRM(suffix) {
        return () => {
            const { txt, qty } = getRM(suffix);
            txt.textContent = qty + 10;
        }
    }

    function swapJobs() {
        DATA.worker = "setup";
        const w = viz.querySelector("#worker3");
        getItem500(DATA.job).classList.remove("move2");
        w.classList.remove("busy");
        if(w.getAttribute("cx")==="100") {
            w.setAttribute("cx", "400");
            DATA.job = "b";
        } else {
            w.setAttribute("cx", "100");
            DATA.job = "a";
        }
    }
    const btns = document.querySelectorAll(".controls button");
    btns[0].addEventListener("click", buyRM("a"));
    btns[1].addEventListener("click", buyRM("b"));
    btns[2].addEventListener("click", swapJobs);

    function addJobListener(viz) {
        const w = viz.querySelector("#worker3");
        w.addEventListener("transitionend", () => {
            DATA.worker = "ready";
            w.classList.add("busy");
            getItem500(DATA.job).classList.add("move2");
        })
    }
    function addItemsListeners(viz) {
        // const items = viz.querySelectorAll("g#items use");
        // items[2].addEventListener("animationiteration", () => {
        //     const { txt, qty } = getRM("a");
        //     txt.textContent = qty - 1;
        //     if (qty - 1 === 0) {
                
        //     }
        // })
    }

</script>

</html>