<!DOCTYPE html>
<html>

<head>
  <title>Structure Chart Editor</title>
  <style>
    .the-grid {
      display: grid;
      grid-template-columns: auto 8rem 1fr;
      column-gap: 0.5rem;
    }

    .the-display,
    .the-input {
      border: solid thin silver;
    }

    button {
      width: 100%;
    }
  </style>
</head>

<body>
  <h2>Structure Chart Editor</h2>
  <div class="the-grid">
    <div>
      <span class="label">Input</span>
      <!-- Format: <select id="format">
        <option>Simple</option>
        <option>Sketch</option>
      </select> -->
    </div>
    <span class="label">Convert</span>
    <span class="label">Output</span>
    <div class="the-input">
      <textarea rows="30" cols="80" spellcheck="false" autocomplete="off" autocorrect="off"></textarea>
    </div>

    <div class="the-controls">
      <button id="b0">Raw</button>
      <button id="b1">DOT</button>
      <button id="b2">DOT2</button>
      <button id="b3">Sketch</button>
      <!-- <button id="b4">XState</button> -->
    </div>

    <div class="the-display">
      <textarea rows="30" cols="80" spellcheck="false" autocomplete="off" autocorrect="off"></textarea>
    </div>
  </div>
  <a href="./svgEdit.html">Simple SVG editor</a>
  <a href="./stateChartEdit.html">State Chart editor</a>
</body>
<script>
  {
    // Initial view.
    const SAMPLE_INPUT = `Grandmother\n  Mother\n    Daughter1\n    Daughter2\n      GrandDaughter`;
    const input = document.querySelector(".the-input > textarea");
    const display = document.querySelector(".the-display > textarea");
    input.value = window.localStorage.getItem("INPUT_STRUCTURE") || SAMPLE_INPUT;

    function toArray(txt = "") {
      return txt.split("\n").flatMap(line => {
        line = line.trimEnd();
        return line.length === 0 ? [] : line;
      });
    }

    function updateStack(stack, node) {
      const peek = stack[stack.length - 1];
      if (node.indent > peek.indent) {
        stack.push(node);
      } else {
        stack.pop();
        updateStack(stack, node);
      }
    }

    function makeLink(stack) {
      const len = stack.length;
      const src = stack[len - 2].id;
      const tgt = stack[len - 1].id;
      return { src, tgt };
    }

    // Sketch-format parser
    function parser(txt) {
      const nodeStack = [];
      const lines = toArray(txt);
      const nodeMap = {}; // map id -> node
      const links = [];
      const nodes = [];
      lines.forEach(line => {
        const node = parseLine(line);
        nodeMap[node.id] = node;
        nodes.push(node);
      })

      nodes.forEach((node, index) => {
        if (index === 0) {
          nodeStack.push(node);
          return;
        }
        if (node.indent === 0) {
          throw new Error("Invalid format: must only have one parent node");
        }
        updateStack(nodeStack, node);
        links.push(makeLink(nodeStack));
      })

      return { nodes, links, nodeMap };
    }

    let index = 0;

    function parseLine(raw) {
      const indent = raw.search(/\S/);
      const name = raw.trim();
      const id = `n${index++}`;
      return { id, indent, name };
    }


    let parsed = {};

    // function parse() {
    //   const txt = input.value;
    //   return parser(txt);
    // }

    input.addEventListener("blur", evt => {
      parsed = parser(evt.target.value);
      window.localStorage.setItem("INPUT_STRUCTURE", evt.target.value);
    })

    // Raw format
    document.querySelector("button#b0").addEventListener("click", evt => {
      display.value = JSON.stringify(parsed, null, 3);
    })

    // DOT format
    document.querySelector("button#b1").addEventListener("click", evt => {
      const { nodes, links, nodeMap } = parsed;
      if (!nodes) return;
      const output = ["digraph {",
        "  node [shape=box]",
        ...nodes.map(n => `  ${n.id} [label="${n.name}"]`),
        ...links.map(l => `  ${l.src} -> ${l.tgt}`),
        "}"
      ];
      display.value = output.join("\n");
    })
    // DOT format, bipartite graph
    document.querySelector("button#b2").addEventListener("click", evt => {
      const { nodes, links, nodeMap } = parsed;
      if (!nodes) return;
      const output = ["digraph {",
        "  node [color=blue shape=box]",
        ...nodes.map(n => `  ${n.id} [label="${n.name}"]`),
        '  node [color="#A0A0A0" shape=oval fontsize="10pt"]',
        ...links.map(l => `  ${l.src}_${l.tgt} [label="${l.label}"]`),
        ...links.map(l => `  ${l.src} -> ${l.src}_${l.tgt}`),
        ...links.map(l => `  ${l.src}_${l.tgt} -> ${l.tgt}`),
        "}"
      ];
      display.value = output.join("\n");
    })

    // Sketch systems format
    document.querySelector("button#b3").addEventListener("click", evt => {
      const output = [];
      const { nodes, links, nodeMap } = parsed;
      if (!nodes) return;
      nodes.forEach(node => {
        const { id, name } = node;
        output.push(name);
        const fedbys = links.filter(link => link.src === id);
        fedbys.forEach(link => {
          const tgt = nodeMap[link.tgt];
          output.push(`  ${link.label} -> ${tgt.name}`);
        });
      })
      display.value = output.join("\n");
    })

    input.focus();

  }
</script>

</html>